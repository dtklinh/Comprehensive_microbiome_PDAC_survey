---
title: "Chap3_DecontaminationPerformance"
author: "Linh Dang"
format: html
editor: visual
---

```{r echo=F, results='hide'}
library(phyloseq)
library(reshape2)
library(microViz)
library(microbiome)
library(vegan)
library(lme4)       # Linear Mixed Models (for repeated measures)
library(lmerTest)   # P-values for Mixed Models
library(emmeans)    # Pairwise comparisons
library(Wrench)
library(tidyverse)
```

# Part1: Do the decontamination approaches perform differently?

```{r}
rm(list = ls())
source("../../../add_code/Functions.R")
df_additionalInfo <- readxl::read_xlsx("../../../meta/Mice_meta.xlsx")
pseq_raw <- readRDS("../../../data/Chap3/pseq_Proj5_postFilter_v04.rds") %>% 
  ps_filter(ffpe.bulk == "bulk") %>% 
  ps_filter(true.control == "true") %>% 
  append_AN_NR(df_additional = df_additionalInfo) %>% 
  WrenchWrapper(grp = "Sex") 
pseq_restrictive <- readRDS("../../../data/Chap3/pseq_bulk_restrictive.rds") %>% 
  append_AN_NR(df_additionalInfo) %>% 
  WrenchWrapper(grp = "Sex")
pseq_decontam <- readRDS("../../../data/Chap3/pseq_bulk_decontam_p0.5.rds") %>% 
  append_AN_NR(df_additionalInfo) %>% 
  WrenchWrapper(grp = "Sex")
pseq_SCRuB <- readRDS("../../../data/Chap3/pseq_bulk_SCRuB.rds") %>% 
  append_AN_NR(df_additionalInfo) %>% 
  WrenchWrapper(grp = "Sex")
pseq_Nj <- readRDS("../../../data/Chap3/pseq_bulk_Fisher_v02.rds") %>% 
  append_AN_NR(df_additionalInfo) %>% 
  WrenchWrapper(grp = "Sex")
```

## Alpha Diversity

```{r}
## alpha plot function with LMM with fixed and random variables
AlphaPlot_Violin_LMM <- function(df, SampleID, strata, val, metric = "Obsered species"){
  ## df: in pivot longer manner
  ## calc p value in manner of paired
  ## get y.position for ggplot
  y_pos <- t_test(formula = as.formula(sprintf("%s ~ %s", val, strata)), data = df) %>% add_xy_position() %>% pull(y.position)
  model <- lmer(as.formula(sprintf("%s ~ %s + (1|%s)", val, strata, SampleID)), data = df)
  emm <- emmeans(model, specs = as.formula(sprintf("pairwise ~ %s", strata)))
  contr <- contrast(emm, method = "pairwise")
  
  p_add <- contr %>% 
    as_tibble() %>%
    transmute(
      group1 = sub(" - .*", "", contrast),
      group2 = sub(".* - ", "", contrast),
      estimate,
      se = SE,
      statistic = t.ratio,
      df,
      p = p.value
      ##method = "emmeans model-based t-test"
    ) %>% 
    add_significance() %>% 
    mutate(y.position = y_pos)
  plt <- ggplot(df, aes(x = .data[[strata]], y = .data[[val]], fill = .data[[strata]])) +
    geom_violin() +
    #geom_boxplot(alpha = 0.6, outlier.shape = NA) +
    geom_boxplot(width=0.2) +
    geom_point(position = position_jitter(width = 0.1), alpha = 0.5) +
    # Connect lines for the same sample to show paired changes
    geom_line(aes(group = AN_NR), color = "gray", alpha = 0.5) +
    theme_minimal() +
    labs(
      title = "Comparison of Decontamination Methods",
      subtitle = sprintf("Alpha Diversity: %s", metric),
      y = metric
    ) +
    theme(legend.position = "none")
  plt <- plt + stat_pvalue_manual(p_add, label = "p.signif", inherit.aes = FALSE, tip.length = 0.01)
  return(plt)
}
## function dealing with df
extract_df <- function(lst_pseq, diversity = "obs"){
  ## diversity: obs, shannon, simpson, invsimpson
  ## extract meta
  df_meta <- meta(lst_pseq[[1]]) %>% 
    rownames_to_column(var = "SampleID") %>% 
    dplyr::select(SampleID, AN_NR)
  df_full <- df_meta
  for(nm in names(lst_pseq)){
    #print(nm)
    if(diversity == "obs"){
      div <- lst_pseq[[nm]] %>% 
        otu_table() %>% 
        specnumber(MARGIN = 2)
      df_tmp <- tibble(SampleID = names(div), !!nm := unname(div))
    }else{
      div <- lst_pseq[[nm]] %>% 
        otu_table() %>% 
        vegan::diversity(index = diversity, MARGIN = 2)
      df_tmp <- tibble(SampleID = names(div), !!nm := unname(div))
    }
    
    df_full <- df_full %>% 
      merge(., df_tmp, by = "SampleID")
    #print(df_full)
  }
  df_full_longer <- df_full %>% 
    select(-SampleID) %>% 
    pivot_longer(cols = -AN_NR, names_to = "Method", values_to = "Val")
  return(df_full_longer)
}
```

Plot various alpha diversity among decontamination approaches, with Linear Mixed Model as paired statistical test

```{r}
ls_pseq <- list(Raw = pseq_raw, Restrictive = pseq_restrictive, decontam = pseq_decontam, SCRuB = pseq_SCRuB, Nj = pseq_Nj)
```

### Observed Species

```{r}
## 
df <- extract_df(ls_pseq, diversity = "obs")
AlphaPlot_Violin_LMM(df, "AN_NR", "Method", "Val", "Observed Species")
```

### Shannon

```{r}
## shannon
df <- extract_df(ls_pseq, diversity = "shannon")
AlphaPlot_Violin_LMM(df, "AN_NR", "Method", "Val", "Shannon Index")
```

### Inversed  Simpson

```{r}
## invsimpson
df <- extract_df(ls_pseq, diversity = "invsimpson")
AlphaPlot_Violin_LMM(df, "AN_NR", "Method", "Val", "invsimpson Index")
```

## Beta Diversity

Plot beta diversity of samples before and after decontaminated through various approaches

Raw vs Nejman

```{r}
pseq_raw <- pseq_raw %>% 
  ps_mutate(Decon_type = "Raw")
sample_names(pseq_raw) <- sprintf("%s_%s", "Raw", meta(pseq_raw)[["AN_NR"]])
pseq_Nj <- pseq_Nj %>% 
  ps_mutate(Decon_type = "Nj")
sample_names(pseq_Nj) <- sprintf("%s_%s", "Nj", meta(pseq_Nj)[["AN_NR"]])
pseq_RN <- merge_phyloseq(pseq_raw, pseq_Nj)
```

```{r}
beta_plot_microViz(pseq_RN, taxa_rank = "species", m_group = "Decon_type")
```

Raw vs. SCRuB

```{r}
pseq_SCRuB <- pseq_SCRuB %>% 
  ps_mutate(Decon_type = "SCRuB")
sample_names(pseq_SCRuB) <- sprintf("%s_%s", "SCRuB", meta(pseq_SCRuB)[["AN_NR"]])
pseq_RS <- merge_phyloseq(pseq_raw, pseq_SCRuB)
beta_plot_microViz(pseq_RS, taxa_rank = "species", m_group = "Decon_type")
```

Raw vs. restrictuve

```{r}
pseq_restrictive <- pseq_restrictive %>% 
  ps_mutate(Decon_type = "Restrictive")
sample_names(pseq_restrictive) <- sprintf("%s_%s", "Restrictive", meta(pseq_SCRuB)[["AN_NR"]])
pseq_RR <- merge_phyloseq(pseq_raw, pseq_restrictive)
beta_plot_microViz(pseq_RR, taxa_rank = "species", m_group = "Decon_type")
```

Raw vs. decontam

```{r}
pseq_decontam <- pseq_decontam %>% 
  ps_mutate(Decon_type = "decontam")
sample_names(pseq_decontam) <- sprintf("%s_%s", "decontam", meta(pseq_decontam)[["AN_NR"]])
pseq_RD <- merge_phyloseq(pseq_raw, pseq_decontam)
beta_plot_microViz(pseq_RD, taxa_rank = "species", m_group = "Decon_type")
```

All

```{r}
pseq_merge <- merge_phyloseq(pseq_raw, pseq_restrictive, pseq_decontam, pseq_SCRuB, pseq_Nj)
beta_plot_microViz(pseq_merge, taxa_rank = "species", m_group = "Decon_type")
```

## Bacterial Composition

Investigate the most dominant bacterial composition before and after decontamination approaches.

## Bacterial Barplot

```{r}
pseq_merge %>% 
  ps_mutate(Decon_type = factor(Decon_type, levels = c("Raw", "Restrictive", "decontam", "SCRuB", "Nj"))) %>% 
  comp_barplot(tax_level = "genus", n_taxa = 20, bar_outline_colour = NA, facet_by = "Decon_type")+
  coord_flip() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

## Inspect Species

# Part2
