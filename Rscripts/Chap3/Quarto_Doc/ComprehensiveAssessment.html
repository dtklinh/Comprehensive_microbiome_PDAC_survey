<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Linh Dang">

<title>Comprehensive Assessment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ComprehensiveAssessment_files/libs/clipboard/clipboard.min.js"></script>
<script src="ComprehensiveAssessment_files/libs/quarto-html/quarto.js"></script>
<script src="ComprehensiveAssessment_files/libs/quarto-html/popper.min.js"></script>
<script src="ComprehensiveAssessment_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ComprehensiveAssessment_files/libs/quarto-html/anchor.min.js"></script>
<link href="ComprehensiveAssessment_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ComprehensiveAssessment_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ComprehensiveAssessment_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ComprehensiveAssessment_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ComprehensiveAssessment_files/libs/bootstrap/bootstrap-34af8a4e30fcaa834c5f714e2bbc225f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#comprehensive-assessment-of-decontamination-methods" id="toc-comprehensive-assessment-of-decontamination-methods" class="nav-link active" data-scroll-target="#comprehensive-assessment-of-decontamination-methods">Comprehensive Assessment of Decontamination Methods</a></li>
  <li><a href="#assessment-of-batch-effect-removal" id="toc-assessment-of-batch-effect-removal" class="nav-link" data-scroll-target="#assessment-of-batch-effect-removal">1. Assessment of batch effect removal</a>
  <ul class="collapse">
  <li><a href="#restrictive" id="toc-restrictive" class="nav-link" data-scroll-target="#restrictive">Restrictive</a></li>
  <li><a href="#decontam" id="toc-decontam" class="nav-link" data-scroll-target="#decontam">Decontam</a></li>
  <li><a href="#scrub" id="toc-scrub" class="nav-link" data-scroll-target="#scrub">SCRuB</a></li>
  <li><a href="#nejman" id="toc-nejman" class="nav-link" data-scroll-target="#nejman">Nejman</a></li>
  <li><a href="#overall-results" id="toc-overall-results" class="nav-link" data-scroll-target="#overall-results">Overall Results</a></li>
  </ul></li>
  <li><a href="#divergence-from-negative-controls" id="toc-divergence-from-negative-controls" class="nav-link" data-scroll-target="#divergence-from-negative-controls">2. Divergence from Negative Controls</a>
  <ul class="collapse">
  <li><a href="#raw" id="toc-raw" class="nav-link" data-scroll-target="#raw">Raw</a></li>
  <li><a href="#restrictive-1" id="toc-restrictive-1" class="nav-link" data-scroll-target="#restrictive-1">Restrictive</a></li>
  <li><a href="#decontam-1" id="toc-decontam-1" class="nav-link" data-scroll-target="#decontam-1">Decontam</a></li>
  <li><a href="#scrub-1" id="toc-scrub-1" class="nav-link" data-scroll-target="#scrub-1">SCRuB</a></li>
  <li><a href="#nejman-1" id="toc-nejman-1" class="nav-link" data-scroll-target="#nejman-1">Nejman</a></li>
  </ul></li>
  <li><a href="#biologically-meaningful-of-consensus-taxa" id="toc-biologically-meaningful-of-consensus-taxa" class="nav-link" data-scroll-target="#biologically-meaningful-of-consensus-taxa">3. Biologically meaningful of Consensus taxa</a></li>
  <li><a href="#overlap-with-known-true-taxa-contaminants" id="toc-overlap-with-known-true-taxa-contaminants" class="nav-link" data-scroll-target="#overlap-with-known-true-taxa-contaminants">4. Overlap with known true taxa / contaminants</a>
  <ul class="collapse">
  <li><a href="#method-1-abundance-based-approach" id="toc-method-1-abundance-based-approach" class="nav-link" data-scroll-target="#method-1-abundance-based-approach">Method 1: Abundance-based Approach</a></li>
  <li><a href="#method-2-prevalence-based-approach" id="toc-method-2-prevalence-based-approach" class="nav-link" data-scroll-target="#method-2-prevalence-based-approach">Method 2: Prevalence-based Approach</a></li>
  <li><a href="#method-3-combination-of-abundance-and-prevalence" id="toc-method-3-combination-of-abundance-and-prevalence" class="nav-link" data-scroll-target="#method-3-combination-of-abundance-and-prevalence">Method 3: Combination of Abundance and Prevalence</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Comprehensive Assessment</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Linh Dang </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phyloseq)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstatix)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microViz)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbiome)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Wrench)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Functions</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Kolors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#9d547c"</span>,<span class="st">"#56ca63"</span>,<span class="st">"#a357d6"</span>,<span class="st">"cornflowerblue"</span>,<span class="st">"#419d2a"</span>,<span class="st">"sandybrown"</span>,<span class="st">"red3"</span>,<span class="st">"peachpuff"</span>,<span class="st">"cyan"</span>,<span class="st">"paleturquoise3"</span>,<span class="st">"mistyrose"</span>,<span class="st">"mediumpurple"</span>,<span class="st">"mediumseagreen"</span>,<span class="st">"mediumorchid"</span>,<span class="st">"moccasin"</span>,<span class="st">"orange4"</span>,<span class="st">"olivedrab"</span>,<span class="st">"midnightblue"</span>,<span class="st">"papayawhip"</span>,<span class="st">"palevioletred4"</span>,<span class="st">"brown1"</span>,<span class="st">"greenyellow"</span>,<span class="st">"orchid"</span>,<span class="st">"navy"</span>,<span class="st">"darkred"</span>,<span class="st">"navajowhite1"</span>,<span class="st">"mistyrose1"</span>,<span class="st">"grey85"</span>,<span class="st">"#525fd6"</span>,<span class="st">"red2"</span>,<span class="st">"#8cbe3a"</span>,<span class="st">"#c944aa"</span>,<span class="st">"indianred3"</span>,<span class="st">"#5ba557"</span>,<span class="st">"#9e66cb"</span>,<span class="st">"#c1b735"</span>,<span class="st">"#6d82ec"</span>,<span class="st">"grey25"</span>,<span class="st">"#e69728"</span>,<span class="st">"#6654b0"</span>,<span class="st">"lightsalmon3"</span>,<span class="st">"lightcyan1"</span>,<span class="st">"khaki1"</span>,<span class="st">"seagreen1"</span>,<span class="st">"plum1"</span>,<span class="st">"lightsteelblue1"</span>,<span class="st">"palevioletred3"</span>,<span class="st">"mintcream"</span>,<span class="st">"magenta3"</span>,<span class="st">"#799330"</span>,<span class="st">"#da7fdf"</span>,<span class="st">"#3c782c"</span>,<span class="st">"#e44586"</span>,<span class="st">"blue4"</span>,<span class="st">"#63c996"</span>,<span class="st">"#dc3f53"</span>,<span class="st">"#49cbc8"</span>,<span class="st">"#cf3f29"</span>,<span class="st">"#4fabda"</span>,<span class="st">"#da6c2b"</span>,<span class="st">"#598bd1"</span>,<span class="st">"#b78c24"</span>,<span class="st">"#8d4191"</span>,<span class="st">"#a0b971"</span>,<span class="st">"slategray1"</span>,<span class="st">"sienna"</span>,<span class="st">"plum1"</span>,<span class="st">"lightyellow1"</span>,<span class="st">"lightskyblue3"</span>,<span class="st">"linen"</span>,<span class="st">"limegreen"</span>,<span class="st">"cornsilk1"</span>,<span class="st">"mediumaquamarine"</span>,<span class="st">"gray14"</span>,<span class="st">"gold3"</span>,<span class="st">"darkviolet"</span>,<span class="st">"#b2386a"</span>,<span class="st">"#479d71"</span>,<span class="st">"#ae4341"</span>,<span class="st">"#2ba198"</span>,<span class="st">"#e07557"</span>,<span class="st">"#5361a3"</span>,<span class="st">"#dda353"</span>,<span class="st">"#aa98df"</span>,<span class="st">"#5b6114"</span>,<span class="st">"#dc89bf"</span>,<span class="st">"#327243"</span>,<span class="st">"slateblue1"</span>,<span class="st">"#e57b94"</span>,<span class="st">"#277257"</span>,<span class="st">"#9b62a0"</span>,<span class="st">"#bbab59"</span>,<span class="st">"#98495a"</span>,<span class="st">"#526229"</span>,<span class="st">"#d8827d"</span>,<span class="st">"#857624"</span>,<span class="st">"gray40"</span>,<span class="st">"#9a4a22"</span>,<span class="st">"#7c7d46"</span>,<span class="st">"mediumslateblue"</span>,<span class="st">"lemonchiffon1"</span>,<span class="st">"#e3a073"</span>,<span class="st">"#9e6b33"</span>, <span class="st">"gray74"</span>,<span class="st">"slateblue1"</span>,<span class="st">"rosybrown3"</span>, <span class="st">"lawngreen"</span>,<span class="st">"gainsboro"</span>,<span class="st">"dodgerblue3"</span>,<span class="st">"deeppink3"</span>,<span class="st">"firebrick3"</span>, <span class="st">"orchid2"</span>, <span class="st">"olivedrab1"</span>, <span class="st">"ivory3"</span>, <span class="st">"darkseagreen"</span>, <span class="st">"bisque2"</span>, <span class="st">"darkgoldenrod2"</span>, <span class="st">"blue2"</span>, <span class="st">"skyblue"</span>, <span class="st">"seashell2"</span>, <span class="st">"turquoise"</span>, <span class="st">"tan1"</span>, <span class="st">"seagreen2"</span>, <span class="st">"palevioletred3"</span>, <span class="st">"linen"</span>, <span class="st">"steelblue4"</span>,<span class="st">"ghostwhite"</span>,<span class="st">"dodgerblue1"</span>,<span class="st">"deeppink1"</span>,<span class="st">"firebrick1"</span>, <span class="st">"limegreen"</span>, <span class="st">"purple3"</span>, <span class="st">"khaki3"</span>, <span class="st">"snow3"</span>, <span class="st">"darkslategray"</span>,<span class="st">"darkorchid"</span>,<span class="st">"lavender"</span>, <span class="st">"magenta2"</span>, <span class="st">"palegreen"</span>, <span class="st">"salmon"</span>, <span class="st">"maroon"</span>, <span class="st">"cyan2"</span>,<span class="st">"#671408"</span>,<span class="st">"#FAEBD7"</span>,<span class="st">"#7FFFD4"</span>,<span class="st">"#F0FFFF"</span>,<span class="st">"#A52A2A"</span>,<span class="st">"burlywood"</span>,<span class="st">"cadetblue"</span>,<span class="st">"#7FFF00"</span>,<span class="st">"chocolate"</span>,<span class="st">"cornsilk"</span>,<span class="st">"slateblue1"</span>,<span class="st">"#FF7F50"</span>,<span class="st">"red1"</span>,<span class="st">"#008B8B"</span>,<span class="st">"darkgoldenrod1"</span>,<span class="st">"darkolivegreen"</span>,<span class="st">"darkorange4"</span>,<span class="st">"white"</span>,<span class="st">"hotpink"</span>,<span class="st">"honeydew1"</span>,<span class="st">"goldenrod2"</span>,<span class="st">"darkgreen"</span>,<span class="st">"oldlace"</span>,<span class="st">"darkslategray3"</span>,<span class="st">"navajowhite3"</span>,<span class="st">"orchid4"</span>,<span class="st">"gray25"</span>,<span class="st">"#F0924D"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>WrenchWrapper <span class="ot">&lt;-</span> <span class="cf">function</span>(PhyloObjct, grp, <span class="at">roundUp =</span> F){</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  cnt_table <span class="ot">&lt;-</span> PhyloObjct <span class="sc">%&gt;%</span> <span class="fu">otu_table</span>()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  group <span class="ot">&lt;-</span> PhyloObjct <span class="sc">%&gt;%</span> <span class="fu">sample_data</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(grp)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">wrench</span>(cnt_table, <span class="at">condition =</span> group)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># deseq.obj &lt;- DESeqDataSetFromMatrix(cnt_table %&gt;% as.data.frame(), DataFrame(group), ~group)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># DESeq2::sizeFactors(deseq.obj) &lt;- w$nf</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnt_table_normalized &lt;- DESeq2::counts(deseq.obj, normalized=TRUE)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  norm_factors <span class="ot">&lt;-</span> w<span class="sc">$</span>nf</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  norm_counts <span class="ot">&lt;-</span> <span class="fu">sweep</span>(cnt_table, <span class="dv">2</span>, norm_factors, <span class="at">FUN =</span> <span class="st">'/'</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(roundUp){norm_counts <span class="ot">&lt;-</span> norm_counts <span class="sc">%&gt;%</span> <span class="fu">round</span>()}</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">phy_tree</span>(PhyloObjct, <span class="at">errorIfNULL =</span> F))){</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">phyloseq</span>(<span class="fu">otu_table</span>(norm_counts, <span class="at">taxa_are_rows =</span> T), <span class="fu">tax_table</span>(PhyloObjct <span class="sc">%&gt;%</span> <span class="fu">tax_table</span>()), <span class="fu">sample_data</span>(PhyloObjct <span class="sc">%&gt;%</span> <span class="fu">sample_data</span>()),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">phy_tree</span>(PhyloObjct)))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">phyloseq</span>(<span class="fu">otu_table</span>(norm_counts, <span class="at">taxa_are_rows =</span> T), <span class="fu">tax_table</span>(PhyloObjct <span class="sc">%&gt;%</span> <span class="fu">tax_table</span>()), <span class="fu">sample_data</span>(PhyloObjct <span class="sc">%&gt;%</span> <span class="fu">sample_data</span>())))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>append_AN_NR <span class="ot">&lt;-</span> <span class="cf">function</span>(pseq, df_additional){</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  df_meta <span class="ot">&lt;-</span> <span class="fu">meta</span>(pseq)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="st">"AN_NR"</span> <span class="sc">%in%</span>  <span class="fu">colnames</span>(df_meta)){</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"There must be AN_NR column!"</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check if info is already in the main data frame, warning if already exits</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  col_names_fea <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">colnames</span>(df_additional), <span class="st">"AN_NR"</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  new_col_names_fea <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(col_names_fea, <span class="fu">colnames</span>(df_meta))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(new_col_names_fea)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"All new feature already exits, nothing to be added"</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(pseq)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(new_col_names_fea) <span class="sc">&lt;</span> <span class="fu">length</span>(col_names_fea)){</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"partially info already there, add the rest!"</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    df_additional <span class="ot">&lt;-</span> df_additional <span class="sc">%&gt;%</span> </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"AN_NR"</span>, new_col_names_fea))</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  df_meta_new <span class="ot">&lt;-</span> df_meta <span class="sc">%&gt;%</span> </span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"SampleName"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(., df_additional, <span class="at">by =</span> <span class="st">"AN_NR"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">"SampleName"</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_data</span>(pseq) <span class="ot">&lt;-</span> df_meta_new</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pseq)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="do">## alpha plot function with LMM with fixed and random variables</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>AlphaPlot_Violin_LMM <span class="ot">&lt;-</span> <span class="cf">function</span>(df, SampleID, strata, val){</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="do">## df: in pivot longer manner</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calc p value in manner of paired</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get y.position for ggplot</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  y_pos <span class="ot">&lt;-</span> <span class="fu">t_test</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(<span class="fu">sprintf</span>(<span class="st">"%s ~ %s"</span>, val, strata)), <span class="at">data =</span> df) <span class="sc">%&gt;%</span> <span class="fu">add_xy_position</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(y.position)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(<span class="fu">as.formula</span>(<span class="fu">sprintf</span>(<span class="st">"%s ~ %s + (1|%s)"</span>, val, strata, SampleID)), <span class="at">data =</span> df)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="at">specs =</span> <span class="fu">as.formula</span>(<span class="fu">sprintf</span>(<span class="st">"pairwise ~ %s"</span>, strata)))</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  contr <span class="ot">&lt;-</span> <span class="fu">contrast</span>(emm, <span class="at">method =</span> <span class="st">"pairwise"</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  p_add <span class="ot">&lt;-</span> contr <span class="sc">%&gt;%</span> </span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">group1 =</span> <span class="fu">sub</span>(<span class="st">" - .*"</span>, <span class="st">""</span>, contrast),</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">group2 =</span> <span class="fu">sub</span>(<span class="st">".* - "</span>, <span class="st">""</span>, contrast),</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>      estimate,</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">se =</span> SE,</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">statistic =</span> t.ratio,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>      df,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">p =</span> p.value</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>      <span class="do">##method = "emmeans model-based t-test"</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y.position =</span> y_pos)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> .data[[strata]], <span class="at">y =</span> .data[[val]], <span class="at">fill =</span> .data[[strata]])) <span class="sc">+</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_violin</span>() <span class="sc">+</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">#geom_boxplot(alpha = 0.6, outlier.shape = NA) +</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">width=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect lines for the same sample to show paired changes</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> .data[[SampleID]]), <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Comparison of Decontamination Methods - LMM"</span>,</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Metric: Penalized Clean Yield (Higher is Better)"</span>,</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Composite Score</span><span class="sc">\n</span><span class="st">(Yield x Purity)"</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> plt <span class="sc">+</span> <span class="fu">stat_pvalue_manual</span>(p_add, <span class="at">label =</span> <span class="st">"p.signif"</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">tip.length =</span> <span class="fl">0.01</span>)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">plt =</span> plt, <span class="at">const =</span> contr))</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="do">## alpha plot with Wilcon_test</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>AlphaPlot_Violin_Wilcox <span class="ot">&lt;-</span> <span class="cf">function</span>(df, SampleID, strata, val, <span class="at">y_label =</span> <span class="st">"Obsered species"</span>, <span class="at">subtitle =</span> <span class="st">"The higher the better"</span>, ...){</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>  <span class="do">## df: in pivot longer manner</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calc p value in manner of paired</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get y.position for ggplot</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  p_add <span class="ot">&lt;-</span> <span class="fu">wilcox_test</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(<span class="fu">sprintf</span>(<span class="st">"%s ~ %s"</span>, val, strata)), <span class="at">data =</span> df, <span class="at">paired =</span> <span class="cn">TRUE</span>, ...) <span class="sc">%&gt;%</span> </span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_xy_position</span>() <span class="do">##%&gt;% pull(y.position)</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(p_add)</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> .data[[strata]], <span class="at">y =</span> .data[[val]], <span class="at">fill =</span> .data[[strata]])) <span class="sc">+</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_violin</span>() <span class="sc">+</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#geom_boxplot(alpha = 0.6, outlier.shape = NA) +</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">width=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect lines for the same sample to show paired changes</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> .data[[SampleID]]), <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Comparison of Decontamination Methods -Wilcox"</span>,</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Metric: Penalized Clean Yield (Higher is Better)"</span>,</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Composite Score</span><span class="sc">\n</span><span class="st">(Yield x Purity)"</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> plt <span class="sc">+</span> <span class="fu">stat_pvalue_manual</span>(p_add, <span class="at">label =</span> <span class="st">"p.adj.signif"</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">tip.length =</span> <span class="fl">0.01</span>)</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plt)</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(list = ls())</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="do">##source("../../../add_code/Functions.R")</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df_additionalInfo <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"meta/Mice_meta.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  readxl<span class="sc">::</span><span class="fu">read_xlsx</span>()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>pseq_raw <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_Proj5_postFilter_v04.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps_filter</span>(ffpe.bulk <span class="sc">==</span> <span class="st">"bulk"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps_filter</span>(true.control <span class="sc">==</span> <span class="st">"true"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_AN_NR</span>(<span class="at">df_additional =</span> df_additionalInfo) <span class="sc">%&gt;%</span> </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">WrenchWrapper</span>(<span class="at">grp =</span> <span class="st">"Sex"</span>) </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>pseq_restrictive <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_restrictive.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_AN_NR</span>(df_additionalInfo) <span class="sc">%&gt;%</span> </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">WrenchWrapper</span>(<span class="at">grp =</span> <span class="st">"Sex"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>pseq_decontam <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_decontam_p0.5.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_AN_NR</span>(df_additionalInfo) <span class="sc">%&gt;%</span> </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">WrenchWrapper</span>(<span class="at">grp =</span> <span class="st">"Sex"</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>pseq_SCRuB <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_SCRuB.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_AN_NR</span>(df_additionalInfo) <span class="sc">%&gt;%</span> </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">WrenchWrapper</span>(<span class="at">grp =</span> <span class="st">"Sex"</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>pseq_Nj <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_Fisher_v02.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_AN_NR</span>(df_additionalInfo) <span class="sc">%&gt;%</span> </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">WrenchWrapper</span>(<span class="at">grp =</span> <span class="st">"Sex"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="comprehensive-assessment-of-decontamination-methods" class="level2">
<h2 class="anchored" data-anchor-id="comprehensive-assessment-of-decontamination-methods">Comprehensive Assessment of Decontamination Methods</h2>
<p>Due to lacking of ground truth or mock community. Here are the alternative assess approaches we could use:</p>
<ul>
<li><p>Assessment of batch effect removal</p></li>
<li><p>Divergence from Negative Controls</p></li>
<li><p>Biologically meaningful of Consensus taxa</p></li>
<li><p>Overlap with known true taxa / contaminants.</p></li>
</ul>
</section>
<section id="assessment-of-batch-effect-removal" class="level2">
<h2 class="anchored" data-anchor-id="assessment-of-batch-effect-removal">1. Assessment of batch effect removal</h2>
<ul>
<li><p><strong>Main idea</strong>: A good decontamination method should reduce technical variation. In this case is the technician.</p></li>
<li><p><strong>Approach:</strong> Perform Ordination (PCoA) and PERMANOVA (adonis2).</p></li>
<li><p><strong>Metric:</strong> Check if the variance explained (R2) by “Sequencing Run” or “Extraction Batch” decreases after decontamination.</p></li>
<li><p><strong>Logic:</strong> Real tumor microbiomes shouldn’t cluster by which technician sequenced.</p></li>
</ul>
<p>Write a wrapper</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="do">### simple ord plot and permanova</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>assess_batch_effect <span class="ot">&lt;-</span> <span class="cf">function</span>(ps, <span class="at">method =</span> <span class="st">"PCoA"</span>, <span class="at">distance =</span> <span class="st">"bray"</span>, <span class="at">batch =</span> <span class="st">"person"</span>, <span class="at">gg_title =</span> <span class="st">"raw"</span>){</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  ord <span class="ot">&lt;-</span> <span class="fu">ordinate</span>(ps, <span class="at">method =</span> method, <span class="at">distance =</span> distance)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ord_clean &lt;- ordinate(pseq_clean, method = "PCoA", distance = "bray")</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">plot_ordination</span>(ps, ord, <span class="at">color =</span> batch) <span class="sc">+</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">type =</span> <span class="st">"norm"</span>) <span class="sc">+</span> <span class="co"># Adds confidence ellipses per batch</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(gg_title) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calc distance </span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  dis <span class="ot">&lt;-</span> <span class="fu">distance</span>(ps, <span class="at">method =</span> distance)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dist_clean &lt;- distance(pseq_clean, method = "bray")</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  df_meta <span class="ot">&lt;-</span> <span class="fu">meta</span>(ps)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">210488</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  permanova_raw <span class="ot">&lt;-</span> <span class="fu">adonis2</span>(<span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">"dis ~ "</span>, batch)), <span class="at">data =</span> df_meta, <span class="at">permutations =</span> <span class="dv">9999</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">=</span> <span class="fu">list</span>(<span class="at">plt =</span> p1, <span class="at">permanova =</span> permanova_raw)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="restrictive" class="level3">
<h3 class="anchored" data-anchor-id="restrictive">Restrictive</h3>
<section id="assessment-by-visualization" class="level4">
<h4 class="anchored" data-anchor-id="assessment-by-visualization">Assessment by visualization</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>res_raw <span class="ot">&lt;-</span> <span class="fu">assess_batch_effect</span>(pseq_raw, <span class="at">batch =</span> <span class="st">"person"</span>, <span class="at">gg_title =</span> <span class="st">"Raw - Before Decontamination"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>res_restrictive <span class="ot">&lt;-</span> <span class="fu">assess_batch_effect</span>(pseq_restrictive, <span class="at">batch =</span> <span class="st">"person"</span>, <span class="at">gg_title =</span> <span class="st">"After Decon. - Restrictive"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Display side-by-side</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(res_raw<span class="sc">$</span>plt, res_restrictive<span class="sc">$</span>plt, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="statistical-quantification-by-permanova" class="level4">
<h4 class="anchored" data-anchor-id="statistical-quantification-by-permanova">Statistical Quantification by PERMANOVA</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PRINT RESULTS ---</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- RAW DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- RAW DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_raw<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)
Model     1   0.4126 0.07527 1.3024 0.1776
Residual 16   5.0688 0.92473              
Total    17   5.4814 1.00000              </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- CLEAN DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- CLEAN DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_restrictive<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)  
Model     1   0.6762 0.09738 1.7261 0.0195 *
Residual 16   6.2679 0.90262                
Total    17   6.9441 1.00000                
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
<section id="decontam" class="level3">
<h3 class="anchored" data-anchor-id="decontam">Decontam</h3>
<section id="assessment-by-visualization-1" class="level4">
<h4 class="anchored" data-anchor-id="assessment-by-visualization-1">Assessment by visualization</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>res_decontam <span class="ot">&lt;-</span> <span class="fu">assess_batch_effect</span>(pseq_decontam, <span class="at">gg_title =</span> <span class="st">"After Decon. - Decontam"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(res_raw<span class="sc">$</span>plt, res_decontam<span class="sc">$</span>plt, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="statistical-quantification-by-permanova-1" class="level4">
<h4 class="anchored" data-anchor-id="statistical-quantification-by-permanova-1">Statistical Quantification by PERMANOVA</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PRINT RESULTS ---</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- RAW DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- RAW DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_raw<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)
Model     1   0.4126 0.07527 1.3024 0.1776
Residual 16   5.0688 0.92473              
Total    17   5.4814 1.00000              </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- CLEAN DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- CLEAN DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_decontam<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)  
Model     1   0.6312 0.08875 1.5583 0.0352 *
Residual 16   6.4813 0.91125                
Total    17   7.1126 1.00000                
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
<section id="scrub" class="level3">
<h3 class="anchored" data-anchor-id="scrub">SCRuB</h3>
<section id="assessment-by-visualization-2" class="level4">
<h4 class="anchored" data-anchor-id="assessment-by-visualization-2">Assessment by visualization</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res_SCRuB <span class="ot">&lt;-</span> <span class="fu">assess_batch_effect</span>(pseq_SCRuB, <span class="at">gg_title =</span> <span class="st">"After Decon. - SCRuB"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(res_raw<span class="sc">$</span>plt, res_SCRuB<span class="sc">$</span>plt, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="statistical-quantification-by-permanova-2" class="level4">
<h4 class="anchored" data-anchor-id="statistical-quantification-by-permanova-2">Statistical Quantification by PERMANOVA</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PRINT RESULTS ---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- RAW DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- RAW DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_raw<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)
Model     1   0.4126 0.07527 1.3024 0.1776
Residual 16   5.0688 0.92473              
Total    17   5.4814 1.00000              </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- CLEAN DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- CLEAN DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_SCRuB<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)  
Model     1   0.6650 0.09197 1.6205 0.0291 *
Residual 16   6.5661 0.90803                
Total    17   7.2311 1.00000                
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
<section id="nejman" class="level3">
<h3 class="anchored" data-anchor-id="nejman">Nejman</h3>
<section id="assessment-by-visualization-3" class="level4">
<h4 class="anchored" data-anchor-id="assessment-by-visualization-3">Assessment by visualization</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>res_Nj <span class="ot">&lt;-</span> <span class="fu">assess_batch_effect</span>(pseq_Nj, <span class="at">gg_title =</span> <span class="st">"After Decon. - Nejman"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(res_raw<span class="sc">$</span>plt, res_Nj<span class="sc">$</span>plt, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="statistical-quantification-by-permanova-3" class="level4">
<h4 class="anchored" data-anchor-id="statistical-quantification-by-permanova-3">Statistical Quantification by PERMANOVA</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PRINT RESULTS ---</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- RAW DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- RAW DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_raw<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)
Model     1   0.4126 0.07527 1.3024 0.1776
Residual 16   5.0688 0.92473              
Total    17   5.4814 1.00000              </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"--- CLEAN DATA BATCH EFFECT ---"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "--- CLEAN DATA BATCH EFFECT ---"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res_Nj<span class="sc">$</span>permanova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Permutation: free
Number of permutations: 9999

adonis2(formula = as.formula(paste0("dis ~ ", batch)), data = df_meta, permutations = 9999)
         Df SumOfSqs      R2      F Pr(&gt;F)  
Model     1   0.6047 0.09167 1.6147 0.0486 *
Residual 16   5.9922 0.90833                
Total    17   6.5970 1.00000                
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
<section id="overall-results" class="level3">
<h3 class="anchored" data-anchor-id="overall-results">Overall Results</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_overall_R2_pval <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Method =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">R2 =</span> <span class="fu">double</span>(<span class="dv">0</span>),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">p_value =</span> <span class="fu">double</span>(<span class="dv">0</span>))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>df_overall_R2_pval <span class="ot">&lt;-</span> df_overall_R2_pval <span class="sc">%&gt;%</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">Method =</span> <span class="st">"Raw"</span>, <span class="at">R2 =</span> res_raw<span class="sc">$</span>permanova<span class="sc">$</span>R2[<span class="dv">1</span>], <span class="at">p_value =</span> res_raw<span class="sc">$</span>permanova<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">Method =</span> <span class="st">"Restrictive"</span>, <span class="at">R2 =</span> res_restrictive<span class="sc">$</span>permanova<span class="sc">$</span>R2[<span class="dv">1</span>], <span class="at">p_value =</span> res_restrictive<span class="sc">$</span>permanova<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">Method =</span> <span class="st">"decontam"</span>, <span class="at">R2 =</span> res_decontam<span class="sc">$</span>permanova<span class="sc">$</span>R2[<span class="dv">1</span>], <span class="at">p_value =</span> res_decontam<span class="sc">$</span>permanova<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">Method =</span> <span class="st">"SCRuB"</span>, <span class="at">R2 =</span> res_SCRuB<span class="sc">$</span>permanova<span class="sc">$</span>R2[<span class="dv">1</span>], <span class="at">p_value =</span> res_SCRuB<span class="sc">$</span>permanova<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">Method =</span> <span class="st">"Nejman"</span>, <span class="at">R2 =</span> res_Nj<span class="sc">$</span>permanova<span class="sc">$</span>R2[<span class="dv">1</span>], <span class="at">p_value =</span> res_Nj<span class="sc">$</span>permanova<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;F)</span><span class="st">`</span>[<span class="dv">1</span>])</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_overall_R2_pval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  Method          R2 p_value
  &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;
1 Raw         0.0753  0.178 
2 Restrictive 0.0974  0.0195
3 decontam    0.0887  0.0352
4 SCRuB       0.0920  0.0291
5 Nejman      0.0917  0.0486</code></pre>
</div>
</div>
<p>Conclusion: For this dataset, this is not the method we like to choose.</p>
</section>
</section>
<section id="divergence-from-negative-controls" class="level2">
<h2 class="anchored" data-anchor-id="divergence-from-negative-controls">2. Divergence from Negative Controls</h2>
<ul>
<li><p><strong>Approach:</strong> perform Inter-group dissimilarity and Wilcox paired test, following by visualization.</p></li>
<li><p><strong>Metric:</strong> Calculate the Jensen-Shannon Divergence (or Bray-Curtis) between samples and the pool of negative controls.</p></li>
<li><p><strong>Logic:</strong> the decontamination method should maximize the dissimilarity between true PDAC samples and NCTs.</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(list = ls())</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">setdiff</span>(<span class="fu">ls</span>(), <span class="fu">lsf.str</span>()))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>pseq_nct <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_Proj5_postFilter_v04.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps_filter</span>(ffpe.bulk <span class="sc">==</span> <span class="st">"bulk"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps_filter</span>(true.control <span class="sc">!=</span> <span class="st">"true"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Because we could not apply wrench normalization for NCTs, thus we have to use rarefaction</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>s_size <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>pseq_raw_both <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(., <span class="st">"data/Chap3/pseq_Proj5_postFilter_v04.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps_filter</span>(ffpe.bulk <span class="sc">==</span> <span class="st">"bulk"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rarefy_even_depth</span>(<span class="at">sample.size =</span> s_size)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>pseq_restrictive_both <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_restrictive.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge_phyloseq</span>(pseq_nct) <span class="sc">%&gt;%</span> </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rarefy_even_depth</span>(<span class="at">sample.size =</span> s_size)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>pseq_decontam_both <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(., <span class="st">"data/Chap3/pseq_bulk_decontam_p0.5.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge_phyloseq</span>(pseq_nct) <span class="sc">%&gt;%</span> </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rarefy_even_depth</span>(<span class="at">sample.size =</span> s_size)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>pseq_SCRuB_both <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_SCRuB.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge_phyloseq</span>(pseq_nct) <span class="sc">%&gt;%</span> </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rarefy_even_depth</span>(<span class="at">sample.size =</span> s_size)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>pseq_Nj_both <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"data/Chap3/pseq_bulk_Fisher_v02.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge_phyloseq</span>(pseq_nct) <span class="sc">%&gt;%</span> </span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rarefy_even_depth</span>(<span class="at">sample.size =</span> s_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Write a wrapper</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>get_dist_to_controls <span class="ot">&lt;-</span> <span class="cf">function</span>(ps, group_col, <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>, <span class="at">metric =</span> <span class="st">"bray"</span>){</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">tolower</span>(metric) <span class="sc">==</span> <span class="st">"jsd"</span>) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    ps <span class="ot">&lt;-</span> <span class="fu">transform_sample_counts</span>(ps, <span class="cf">function</span>(x) x <span class="sc">/</span> <span class="fu">sum</span>(x))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  dist_mat <span class="ot">&lt;-</span> ps <span class="sc">%&gt;%</span> </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distance</span>(<span class="at">method =</span> metric) <span class="sc">%&gt;%</span> </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(dist_mat)</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  meta <span class="ot">&lt;-</span> <span class="fu">meta</span>(ps)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  true_ids <span class="ot">&lt;-</span> <span class="fu">rownames</span>(meta)[meta[[group_col]] <span class="sc">==</span> true_label]</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  ctrl_ids <span class="ot">&lt;-</span> <span class="fu">rownames</span>(meta)[meta[[group_col]] <span class="sc">==</span> control_label]</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(ctrl_ids)</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  sub_mat <span class="ot">&lt;-</span> dist_mat[true_ids, ctrl_ids, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(sub_mat)</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  mean_dists <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(sub_mat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(mean_dists)</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  median_dists <span class="ot">&lt;-</span> <span class="fu">apply</span>(sub_mat, <span class="dv">1</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(median_dists)</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">SampleID =</span> <span class="fu">names</span>(mean_dists), <span class="at">MeanDist =</span> mean_dists, <span class="at">MedianDist =</span> median_dists))</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="do">### Wrapper of statistics and ggplots</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>wrapper_dist_to_controls <span class="ot">&lt;-</span> <span class="cf">function</span>(ps_raw, ps_clean, group_col, <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>, <span class="at">metric =</span> <span class="st">"bray"</span>, <span class="at">decontam_name =</span> <span class="st">"None"</span>){</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  df_raw <span class="ot">&lt;-</span> <span class="fu">get_dist_to_controls</span>(ps_raw, group_col, true_label, control_label, metric)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  df_clean <span class="ot">&lt;-</span> <span class="fu">get_dist_to_controls</span>(ps_clean, group_col, true_label, control_label, metric)</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  df_raw <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span> <span class="fu">select</span>(SampleID, <span class="at">MeanDist_raw =</span> MeanDist)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  df_clean <span class="ot">&lt;-</span> df_clean <span class="sc">%&gt;%</span> <span class="fu">select</span>(SampleID, <span class="at">MeanDist_clean =</span> MeanDist)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print()</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  df_stats <span class="ot">&lt;-</span> <span class="fu">merge</span>(df_raw, df_clean, <span class="at">by =</span> <span class="st">"SampleID"</span>)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  test_results <span class="ot">&lt;-</span> <span class="fu">wilcox.test</span>(df_stats<span class="sc">$</span>MeanDist_clean, df_stats<span class="sc">$</span>MeanDist_raw,</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>                            <span class="at">paired =</span> <span class="cn">TRUE</span>, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  df_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(df_stats, <span class="at">id.vars=</span><span class="st">"SampleID"</span>, <span class="at">measure.vars=</span><span class="fu">c</span>(<span class="st">"MeanDist_raw"</span>, <span class="st">"MeanDist_clean"</span>))</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>  plt <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_long, <span class="fu">aes</span>(<span class="at">x=</span>variable, <span class="at">y=</span>value, <span class="at">fill=</span>variable)) <span class="sc">+</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">group=</span>SampleID), <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span> <span class="co"># Adds the dots</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group=</span>SampleID), <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span>  <span class="co"># Connects the dots (shows paired change)</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Divergence from Negative Controls"</span>,</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"P-value:"</span>, <span class="fu">format.pval</span>(test_results<span class="sc">$</span>p.value, <span class="at">digits=</span><span class="dv">4</span>)),</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Mean JSD to Negative Controls"</span>,</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Method Stage"</span>) <span class="sc">+</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Raw"</span>, decontam_name))</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">test_results =</span> test_results, <span class="at">plt =</span> plt))</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="raw" class="level3">
<h3 class="anchored" data-anchor-id="raw">Raw</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calc distnace of each sample to negative control group</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> <span class="fu">get_dist_to_controls</span>(pseq_raw_both, <span class="at">group_col =</span> <span class="st">"true.control"</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">metric =</span> <span class="st">"jsd"</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>df_raw <span class="ot">&lt;-</span> df_raw <span class="sc">%&gt;%</span> </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">MeanDist_raw =</span> MeanDist, <span class="at">MedianDist_raw =</span> MedianDist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="restrictive-1" class="level3">
<h3 class="anchored" data-anchor-id="restrictive-1">Restrictive</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">wrapper_dist_to_controls</span>(pseq_raw_both, pseq_restrictive_both,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">group_col =</span> <span class="st">"true.control"</span>, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">metric =</span> <span class="st">"jsd"</span>, <span class="at">decontam_name =</span> <span class="st">"Restrictive"</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res<span class="sc">$</span>test_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Wilcoxon signed rank exact test

data:  df_stats$MeanDist_clean and df_stats$MeanDist_raw
V = 91, p-value = 0.0001221
alternative hypothesis: true location shift is greater than 0</code></pre>
</div>
</div>
<p>GGplot</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="decontam-1" class="level3">
<h3 class="anchored" data-anchor-id="decontam-1">Decontam</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">wrapper_dist_to_controls</span>(pseq_raw_both, pseq_decontam_both,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">group_col =</span> <span class="st">"true.control"</span>, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">metric =</span> <span class="st">"jsd"</span>, <span class="at">decontam_name =</span> <span class="st">"decontam"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res<span class="sc">$</span>test_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Wilcoxon signed rank exact test

data:  df_stats$MeanDist_clean and df_stats$MeanDist_raw
V = 91, p-value = 0.0001221
alternative hypothesis: true location shift is greater than 0</code></pre>
</div>
</div>
<p>GGplot</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="scrub-1" class="level3">
<h3 class="anchored" data-anchor-id="scrub-1">SCRuB</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">wrapper_dist_to_controls</span>(pseq_raw_both, pseq_SCRuB_both,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">group_col =</span> <span class="st">"true.control"</span>, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">metric =</span> <span class="st">"jsd"</span>, <span class="at">decontam_name =</span> <span class="st">"SCRuB"</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res<span class="sc">$</span>test_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Wilcoxon signed rank exact test

data:  df_stats$MeanDist_clean and df_stats$MeanDist_raw
V = 105, p-value = 6.104e-05
alternative hypothesis: true location shift is greater than 0</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="nejman-1" class="level3">
<h3 class="anchored" data-anchor-id="nejman-1">Nejman</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">wrapper_dist_to_controls</span>(pseq_raw_both, pseq_Nj_both,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">group_col =</span> <span class="st">"true.control"</span>, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">true_label =</span> <span class="st">"true"</span>, <span class="at">control_label =</span> <span class="st">"NCT"</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">metric =</span> <span class="st">"jsd"</span>, <span class="at">decontam_name =</span> <span class="st">"Nejman"</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(res<span class="sc">$</span>test_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Wilcoxon signed rank exact test

data:  df_stats$MeanDist_clean and df_stats$MeanDist_raw
V = 78, p-value = 0.0002441
alternative hypothesis: true location shift is greater than 0</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Conclusion: all method performer well!</p>
</section>
</section>
<section id="biologically-meaningful-of-consensus-taxa" class="level2">
<h2 class="anchored" data-anchor-id="biologically-meaningful-of-consensus-taxa">3. Biologically meaningful of Consensus taxa</h2>
</section>
<section id="overlap-with-known-true-taxa-contaminants" class="level2">
<h2 class="anchored" data-anchor-id="overlap-with-known-true-taxa-contaminants">4. Overlap with known true taxa / contaminants</h2>
<ul>
<li><p><strong>Approach:</strong> design a measure quantifying the quality of decontamination approach by balancing the yield and purity explained below.</p></li>
<li><p><strong>Metric: Yield</strong> -&gt; number of putative significant true taxa not in NCTs / number of observed species. <strong>Purity</strong> -&gt; number of putative significant true taxa not in NCTs / whole number of putative contaminants.</p></li>
<li><p><strong>Logic:</strong> a good decontamination methods should give results whose taxa is less overlap with known high prevalence contaminants in large set of NCTs, while not over-removing true taxa.</p></li>
</ul>
<p>In the analysis, we investigate 3 defined methods for putative significant true taxa. The season: even though after decontamination, not all remained taxa are significant and play important rules.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)       <span class="co"># Linear Mixed Models (for repeated measures)</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)   <span class="co"># P-values for Mixed Models</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)    <span class="co"># Pairwise comparisons</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(list = ls())</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">setdiff</span>(<span class="fu">ls</span>(), <span class="fu">lsf.str</span>()))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>df_all <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">"results/Chap3/survey_overlap_NCT/df_all_FisherV02_concat.tsv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For each of a method, we will conduct the following analyses:</p>
<ul>
<li><p>Visualization of the data.</p></li>
<li><p>Linear Mixed Model (LMM) where <em>fixed effect</em> is decontamination methods, and <em>random effect</em> is SampleID (Accounting for biological variation between samples).</p></li>
<li><p>Perform pairwise comparisons.</p></li>
</ul>
<section id="method-1-abundance-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="method-1-abundance-based-approach">Method 1: Abundance-based Approach</h3>
<p>Significant taxa are ones whose abundance are at least 1 percent.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df_analysis <span class="ot">&lt;-</span> df_all <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method2 =</span> <span class="fu">if_else</span>(Method<span class="sc">==</span><span class="st">"Fisher"</span>, <span class="st">"Nj"</span>, Method)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SampleID, <span class="at">Method =</span> Method2, observed, <span class="at">B =</span> NumAbund_1Per, <span class="at">C =</span> NumInNCT_Abd) <span class="sc">%&gt;%</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Calculate "Clean Species" count</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clean_Count =</span> B <span class="sc">-</span> C,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Calculate Yield: (Clean Species / Original Total)</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Yield =</span> Clean_Count <span class="sc">/</span> observed,</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Calculate Purity: (Clean Species / Total Kept)</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If Col_B_Kept is 0, Purity is 0</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Purity =</span> <span class="fu">ifelse</span>(B <span class="sc">&gt;</span> <span class="dv">0</span>, Clean_Count <span class="sc">/</span> B, <span class="dv">0</span>),</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. COMPOSITE METRIC: Penalized Clean Yield</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This rewards keeping good data AND having a clean final table</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Composite_Score =</span> Yield <span class="sc">*</span> Purity</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the calculated metric</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_analysis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  SampleID Method observed     B     C Clean_Count  Yield Purity Composite_Score
  &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;           &lt;dbl&gt;
1 2022_02… origin      211    11     7           4 0.0190  0.364         0.00689
2 2022_02… origin      395    24     8          16 0.0405  0.667         0.0270 
3 2022_02… origin       90    10     6           4 0.0444  0.4           0.0178 
4 2022_02… origin      237    10     5           5 0.0211  0.5           0.0105 
5 2022_02… origin      385    15     6           9 0.0234  0.6           0.0140 
6 2022_02… origin      218     8     4           4 0.0183  0.5           0.00917</code></pre>
</div>
</div>
<p>Visualization</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_analysis, <span class="fu">aes</span>(<span class="at">x =</span> Method, <span class="at">y =</span> Composite_Score, <span class="at">fill =</span> Method)) <span class="sc">+</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Connect lines for the same sample to show paired changes</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> SampleID), <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Decontamination Methods"</span>,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Metric: Penalized Clean Yield (Higher is Better)"</span>,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Composite Score</span><span class="sc">\n</span><span class="st">(Yield x Purity)"</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Composite_Score <span class="sc">~</span> Method <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>SampleID), <span class="at">data =</span> df_analysis)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check assumptions (Residuals should be roughly normal)</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">resid</span>(model))</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">resid</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The normality assumption of residual for LMM is almost satisfied.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ANOVA</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Type III Analysis of Variance Table with Satterthwaite's method
         Sum Sq  Mean Sq NumDF DenDF F value    Pr(&gt;F)    
Method 0.042803 0.010701     4    68  9.7723 2.639e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Pairwise</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform pairwise comparisons with Tukey adjustment for multiple testing</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="at">specs =</span> pairwise <span class="sc">~</span> Method)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Pairwise Differences ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Pairwise Differences ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm<span class="sc">$</span>contrasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> contrast                estimate    SE df t.ratio p.value
 decontam - Nj          -0.027361 0.011 68  -2.481  0.1072
 decontam - origin       0.017432 0.011 68   1.580  0.5149
 decontam - restrictive -0.027586 0.011 68  -2.501  0.1024
 decontam - SCRuB       -0.043221 0.011 68  -3.918  0.0019
 Nj - origin             0.044794 0.011 68   4.061  0.0012
 Nj - restrictive       -0.000225 0.011 68  -0.020  1.0000
 Nj - SCRuB             -0.015860 0.011 68  -1.438  0.6057
 origin - restrictive   -0.045018 0.011 68  -4.081  0.0011
 origin - SCRuB         -0.060654 0.011 68  -5.499 &lt;0.0001
 restrictive - SCRuB    -0.015635 0.011 68  -1.418  0.6187

Degrees-of-freedom method: kenward-roger 
P value adjustment: tukey method for comparing a family of 5 estimates </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== emmeans ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== emmeans ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm<span class="sc">$</span>emmeans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Method      emmean      SE   df lower.CL upper.CL
 decontam    0.0376 0.00962 57.9 0.018393   0.0569
 Nj          0.0650 0.00962 57.9 0.045754   0.0843
 origin      0.0202 0.00962 57.9 0.000961   0.0395
 restrictive 0.0652 0.00962 57.9 0.045979   0.0845
 SCRuB       0.0809 0.00962 57.9 0.061614   0.1001

Degrees-of-freedom method: kenward-roger 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>Conclusion: For this method, SCRuB seem to be outperform others.</p>
</section>
<section id="method-2-prevalence-based-approach" class="level3">
<h3 class="anchored" data-anchor-id="method-2-prevalence-based-approach">Method 2: Prevalence-based Approach</h3>
<p>Taxa with prevalence 50% are considered significant</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>df_analysis <span class="ot">&lt;-</span> df_all <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Method2 =</span> <span class="fu">if_else</span>(Method<span class="sc">==</span><span class="st">"Fisher"</span>, <span class="st">"Nj"</span>, Method)) <span class="sc">%&gt;%</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SampleID, <span class="at">Method =</span> Method2, observed, <span class="at">B =</span> NumPrev_50Per, <span class="at">C =</span> NumInNCT_prev) <span class="sc">%&gt;%</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Calculate "Clean Species" count</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clean_Count =</span> B <span class="sc">-</span> C,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Calculate Yield: (Clean Species / Original Total)</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Yield =</span> Clean_Count <span class="sc">/</span> observed,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Calculate Purity: (Clean Species / Total Kept)</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If Col_B_Kept is 0, Purity is 0</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Purity =</span> <span class="fu">ifelse</span>(B <span class="sc">&gt;</span> <span class="dv">0</span>, Clean_Count <span class="sc">/</span> B, <span class="dv">0</span>),</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. COMPOSITE METRIC: Penalized Clean Yield</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This rewards keeping good data AND having a clean final table</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Composite_Score =</span> Yield <span class="sc">*</span> Purity</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the calculated metric</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_analysis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  SampleID  Method observed     B     C Clean_Count Yield Purity Composite_Score
  &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;           &lt;dbl&gt;
1 2022_02_… origin      211   140    56          84 0.398  0.6             0.239
2 2022_02_… origin      395   204    91         113 0.286  0.554           0.158
3 2022_02_… origin       90    71    43          28 0.311  0.394           0.123
4 2022_02_… origin      237   150    66          84 0.354  0.56            0.198
5 2022_02_… origin      385   203    88         115 0.299  0.567           0.169
6 2022_02_… origin      218   151    66          85 0.390  0.563           0.219</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_analysis, <span class="fu">aes</span>(<span class="at">x =</span> Method, <span class="at">y =</span> Composite_Score, <span class="at">fill =</span> Method)) <span class="sc">+</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Connect lines for the same sample to show paired changes</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> SampleID), <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Decontamination Methods"</span>,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Metric: Penalized Clean Yield (Higher is Better)"</span>,</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Composite Score</span><span class="sc">\n</span><span class="st">(Yield x Purity)"</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Composite_Score <span class="sc">~</span> Method <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>SampleID), <span class="at">data =</span> df_analysis)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check assumptions (Residuals should be roughly normal)</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">resid</span>(model))</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">resid</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The normality assumption for LMM here is satisfied perfectly.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ANOVA</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Type III Analysis of Variance Table with Satterthwaite's method
        Sum Sq Mean Sq NumDF DenDF F value    Pr(&gt;F)    
Method 0.73319  0.1833     4    68  121.19 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Pairwise</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform pairwise comparisons with Tukey adjustment for multiple testing</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="at">specs =</span> pairwise <span class="sc">~</span> Method)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Pairwise Differences ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Pairwise Differences ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm<span class="sc">$</span>contrasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> contrast               estimate    SE df t.ratio p.value
 decontam - Nj           -0.1204 0.013 68  -9.287 &lt;0.0001
 decontam - origin        0.0281 0.013 68   2.168  0.2042
 decontam - restrictive  -0.0446 0.013 68  -3.439  0.0086
 decontam - SCRuB         0.1533 0.013 68  11.829 &lt;0.0001
 Nj - origin              0.1485 0.013 68  11.456 &lt;0.0001
 Nj - restrictive         0.0758 0.013 68   5.848 &lt;0.0001
 Nj - SCRuB               0.2737 0.013 68  21.116 &lt;0.0001
 origin - restrictive    -0.0727 0.013 68  -5.607 &lt;0.0001
 origin - SCRuB           0.1252 0.013 68   9.660 &lt;0.0001
 restrictive - SCRuB      0.1979 0.013 68  15.267 &lt;0.0001

Degrees-of-freedom method: kenward-roger 
P value adjustment: tukey method for comparing a family of 5 estimates </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== emmeans ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== emmeans ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm<span class="sc">$</span>emmeans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Method      emmean     SE df lower.CL upper.CL
 decontam    0.2028 0.0132 41   0.1762   0.2295
 Nj          0.3232 0.0132 41   0.2966   0.3499
 origin      0.1747 0.0132 41   0.1481   0.2014
 restrictive 0.2474 0.0132 41   0.2207   0.2741
 SCRuB       0.0495 0.0132 41   0.0228   0.0761

Degrees-of-freedom method: kenward-roger 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>Conclusion: Nejman procedure with Fisher exact test outperforms the rest.</p>
<p>Alternative using LLM</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>df_analysis<span class="sc">$</span>Method <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_analysis<span class="sc">$</span>Method, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Nj"</span>, <span class="st">"origin"</span>, <span class="st">"decontam"</span>, <span class="st">"restrictive"</span>, <span class="st">"SCRuB"</span>))</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">AlphaPlot_Violin_LMM</span>(df_analysis, <span class="at">SampleID =</span> <span class="st">"SampleID"</span>, <span class="at">strata =</span> <span class="st">"Method"</span>, <span class="at">val =</span> <span class="st">"Composite_Score"</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AlphaPlot_Violin_Wilcox</span>(df_analysis, <span class="at">SampleID =</span> <span class="st">"SampleID"</span>, <span class="at">strata =</span> <span class="st">"Method"</span>, <span class="at">val =</span> <span class="st">"Composite_Score"</span>, <span class="at">y_label =</span> <span class="st">"score"</span>, <span class="at">subtitle =</span> <span class="st">"vxc"</span>, <span class="at">comparisons =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"Nj"</span>, <span class="st">"origin"</span>), <span class="fu">c</span>(<span class="st">"Nj"</span>, <span class="st">"decontam"</span>), <span class="fu">c</span>(<span class="st">"Nj"</span>, <span class="st">"restrictive"</span>), <span class="fu">c</span>(<span class="st">"Nj"</span>, <span class="st">"SCRuB"</span>)), <span class="at">alternative =</span> <span class="st">"greater"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="method-3-combination-of-abundance-and-prevalence" class="level3">
<h3 class="anchored" data-anchor-id="method-3-combination-of-abundance-and-prevalence">Method 3: Combination of Abundance and Prevalence</h3>
<p>Combine two above methods.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>df_analysis <span class="ot">&lt;-</span> df_all <span class="sc">%&gt;%</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SampleID, Method, observed, <span class="at">B =</span> NumPrev_Abd, <span class="at">C =</span> NumInNCT_both) <span class="sc">%&gt;%</span> </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Calculate "Clean Species" count</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Clean_Count =</span> B <span class="sc">-</span> C,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Calculate Yield: (Clean Species / Original Total)</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Yield =</span> Clean_Count <span class="sc">/</span> observed,</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Calculate Purity: (Clean Species / Total Kept)</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If Col_B_Kept is 0, Purity is 0</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Purity =</span> <span class="fu">ifelse</span>(B <span class="sc">&gt;</span> <span class="dv">0</span>, Clean_Count <span class="sc">/</span> B, <span class="dv">0</span>),</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. COMPOSITE METRIC: Penalized Clean Yield</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This rewards keeping good data AND having a clean final table</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Composite_Score =</span> Yield <span class="sc">*</span> Purity</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the calculated metric</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_analysis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  SampleID Method observed     B     C Clean_Count  Yield Purity Composite_Score
  &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;           &lt;dbl&gt;
1 2022_02… origin      211     9     6           3 0.0142  0.333         0.00474
2 2022_02… origin      395    24     8          16 0.0405  0.667         0.0270 
3 2022_02… origin       90    10     6           4 0.0444  0.4           0.0178 
4 2022_02… origin      237    10     5           5 0.0211  0.5           0.0105 
5 2022_02… origin      385    12     5           7 0.0182  0.583         0.0106 
6 2022_02… origin      218     8     4           4 0.0183  0.5           0.00917</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_analysis, <span class="fu">aes</span>(<span class="at">x =</span> Method, <span class="at">y =</span> Composite_Score, <span class="at">fill =</span> Method)) <span class="sc">+</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Connect lines for the same sample to show paired changes</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> SampleID), <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Decontamination Methods"</span>,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Metric: Penalized Clean Yield (Higher is Better)"</span>,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Composite Score</span><span class="sc">\n</span><span class="st">(Yield x Purity)"</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Composite_Score <span class="sc">~</span> Method <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>SampleID), <span class="at">data =</span> df_analysis)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check assumptions (Residuals should be roughly normal)</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">resid</span>(model))</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">resid</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ComprehensiveAssessment_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Normality assumption does not fit at the tails.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ANOVA</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Type III Analysis of Variance Table with Satterthwaite's method
         Sum Sq   Mean Sq NumDF DenDF F value    Pr(&gt;F)    
Method 0.031131 0.0077828     4    68  18.947 1.658e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Pairwise</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform pairwise comparisons with Tukey adjustment for multiple testing</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>emm <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="at">specs =</span> pairwise <span class="sc">~</span> Method)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Pairwise Differences ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Pairwise Differences ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm<span class="sc">$</span>contrasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> contrast               estimate      SE df t.ratio p.value
 decontam - Fisher       -0.0338 0.00676 68  -5.002 &lt;0.0001
 decontam - origin        0.0109 0.00676 68   1.609  0.4968
 decontam - restrictive  -0.0209 0.00676 68  -3.090  0.0235
 decontam - SCRuB         0.0144 0.00676 68   2.127  0.2206
 Fisher - origin          0.0447 0.00676 68   6.612 &lt;0.0001
 Fisher - restrictive     0.0129 0.00676 68   1.913  0.3207
 Fisher - SCRuB           0.0482 0.00676 68   7.130 &lt;0.0001
 origin - restrictive    -0.0317 0.00676 68  -4.699  0.0001
 origin - SCRuB           0.0035 0.00676 68   0.518  0.9852
 restrictive - SCRuB      0.0352 0.00676 68   5.217 &lt;0.0001

Degrees-of-freedom method: kenward-roger 
P value adjustment: tukey method for comparing a family of 5 estimates </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== emmeans ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== emmeans ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm<span class="sc">$</span>emmeans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Method      emmean     SE   df lower.CL upper.CL
 decontam    0.0293 0.0073 36.8 1.45e-02   0.0441
 Fisher      0.0631 0.0073 36.8 4.83e-02   0.0779
 origin      0.0184 0.0073 36.8 3.59e-03   0.0332
 restrictive 0.0501 0.0073 36.8 3.53e-02   0.0649
 SCRuB       0.0149 0.0073 36.8 9.31e-05   0.0297

Degrees-of-freedom method: kenward-roger 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>Conclusion: Nejman procedure and restrictive seem to perform well.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>