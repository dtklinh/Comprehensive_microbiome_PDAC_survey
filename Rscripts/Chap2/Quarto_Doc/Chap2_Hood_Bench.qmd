---
title: "Chap 2 - Hood vs. Bench"
author: "Linh Dang"
editor: visual
execute:
  warning: false
  message: false
format:
  html:
    code-fold: true
    toc: true
    toc-location: left
    toc-depth: 3
---

```{r message=FALSE}
library(phyloseq)
library(microViz)
library(microbiome)
library(vegan)
library(rstatix)
library(ggpubr)
library(Wrench)
library(patchwork)
library(lme4)       # For alpha diversity mixed models
library(lmerTest)
library(tidyverse)

rm(list = ls())
pseq <- readRDS("../../../data/Chap2/px_J_U_NCT_v02.rds") %>% 
  ps_get() %>% 
  tax_filter(min_total_abundance = 2, min_prevalence = 2)
```

# Project Description

Investigate NCT samples in different environments: as normal (BENCH), and clean one (HOOD).

Common variables and functions

```{r echo=TRUE}
Kolors <- c("#9d547c","#56ca63","#a357d6","cornflowerblue","#419d2a","sandybrown","red3","peachpuff","cyan","paleturquoise3","mistyrose","mediumpurple","mediumseagreen","mediumorchid","moccasin","orange4","olivedrab","midnightblue","papayawhip","palevioletred4","brown1","greenyellow","orchid","navy","darkred","navajowhite1","mistyrose1","grey85","#525fd6","red2","#8cbe3a","#c944aa","indianred3","#5ba557","#9e66cb","#c1b735","#6d82ec","grey25","#e69728","#6654b0","lightsalmon3","lightcyan1","khaki1","seagreen1","plum1","lightsteelblue1","palevioletred3","mintcream","magenta3","#799330","#da7fdf","#3c782c","#e44586","blue4","#63c996","#dc3f53","#49cbc8","#cf3f29","#4fabda","#da6c2b","#598bd1","#b78c24","#8d4191","#a0b971","slategray1","sienna","plum1","lightyellow1","lightskyblue3","linen","limegreen","cornsilk1","mediumaquamarine","gray14","gold3","darkviolet","#b2386a","#479d71","#ae4341","#2ba198","#e07557","#5361a3","#dda353","#aa98df","#5b6114","#dc89bf","#327243","slateblue1","#e57b94","#277257","#9b62a0","#bbab59","#98495a","#526229","#d8827d","#857624","gray40","#9a4a22","#7c7d46","mediumslateblue","lemonchiffon1","#e3a073","#9e6b33", "gray74","slateblue1","rosybrown3", "lawngreen","gainsboro","dodgerblue3","deeppink3","firebrick3", "orchid2", "olivedrab1", "ivory3", "darkseagreen", "bisque2", "darkgoldenrod2", "blue2", "skyblue", "seashell2", "turquoise", "tan1", "seagreen2", "palevioletred3", "linen", "steelblue4","ghostwhite","dodgerblue1","deeppink1","firebrick1", "limegreen", "purple3", "khaki3", "snow3", "darkslategray","darkorchid","lavender", "magenta2", "palegreen", "salmon", "maroon", "cyan2","#671408","#FAEBD7","#7FFFD4","#F0FFFF","#A52A2A","burlywood","cadetblue","#7FFF00","chocolate","cornsilk","slateblue1","#FF7F50","red1","#008B8B","darkgoldenrod1","darkolivegreen","darkorange4","white","hotpink","honeydew1","goldenrod2","darkgreen","oldlace","darkslategray3","navajowhite3","orchid4","gray25","#F0924D")

## Alpha analysis
AlphaPlot_Violin_LMM <- function(ps, main_factor, batch_factor, metric = "Obsered"){
  ## ps: phyloseq object
  ## metric: Obsered, shannon, simpson, invsimpson
  ## df: in pivot longer manner
  ## calc p value in manner of paired
  ## get y.position for ggplot
  if(tolower(metric) == "obsered"){
    div <- ps %>% 
      otu_table() %>% 
      specnumber(MARGIN = 2)
    
  }else{
    div <- vegan::diversity(otu_table(ps), index = metric, MARGIN = 2)
  }
  df <- tibble(ID = names(div), Val = unname(div))
  df_meta <- meta(ps)
  df <- merge(df, df_meta, by = "ID")
  
  y_pos <- t_test(formula = as.formula(sprintf("Val ~ %s", main_factor)), data = df) %>% add_xy_position() %>% pull(y.position)
  model <- lmer(as.formula(sprintf("Val ~ %s + (1|%s)", main_factor, batch_factor)), data = df)
  #emm <- emmeans(model, specs = as.formula(sprintf("pairwise ~ %s", main_factor)))
  #contr <- contrast(emm, method = "pairwise")
  
  
  p_add <- model %>%
    anova() %>% 
    as_tibble() %>%
    transmute(
      group1 = "HOOD",
      group2 = "BENCH",
      p = `Pr(>F)`
      ##method = "emmeans model-based t-test"
    ) %>% 
    add_significance() %>% 
    mutate(y.position = y_pos)
  plt <- ggplot(df, aes(x = .data[[main_factor]], y = .data[["Val"]], fill = .data[[main_factor]])) +
    geom_violin() +
    #geom_boxplot(alpha = 0.6, outlier.shape = NA) +
    geom_boxplot(width=0.2) +
    geom_point(position = position_jitter(width = 0.1), alpha = 0.5) +
    # Connect lines for the same sample to show paired changes
    #geom_line(aes(group = AN_NR), color = "gray", alpha = 0.5) +
    theme_minimal() +
    labs(
      #title = "Alpha Diversity",
      title = sprintf("Alpha Diversity: %s", metric),
      y = metric
    ) +
    theme(legend.position = "none")
  plt <- plt + stat_pvalue_manual(p_add, label = "p", inherit.aes = FALSE, tip.length = 0.01)
  return(plt)
}
### Beta

## Wrench Normalization
WrenchWrapper <- function(PhyloObjct, grp, roundUp = F){
  cnt_table <- PhyloObjct %>% otu_table()
  group <- PhyloObjct %>% sample_data() %>% pull(grp)
  w <- wrench(cnt_table, condition = group)
  
  # deseq.obj <- DESeqDataSetFromMatrix(cnt_table %>% as.data.frame(), DataFrame(group), ~group)
  # DESeq2::sizeFactors(deseq.obj) <- w$nf
  # cnt_table_normalized <- DESeq2::counts(deseq.obj, normalized=TRUE)
  
  norm_factors <- w$nf
  norm_counts <- sweep(cnt_table, 2, norm_factors, FUN = '/')
  if(roundUp){norm_counts <- norm_counts %>% round()}
  if(!is.null(phy_tree(PhyloObjct, errorIfNULL = F))){
    return(phyloseq(otu_table(norm_counts, taxa_are_rows = T), tax_table(PhyloObjct %>% tax_table()), sample_data(PhyloObjct %>% sample_data()),
                    phy_tree(PhyloObjct)))
  } else{
    return(phyloseq(otu_table(norm_counts, taxa_are_rows = T), tax_table(PhyloObjct %>% tax_table()), sample_data(PhyloObjct %>% sample_data())))
  }
}
```

# Basic Analysis

## Alpha Diversity

Plot Alpha diversity with p-value calculated via Linea Mixed Model (LMM) with fixed effect is condition (HOOD vs. BENCH) conditioned on random effect technicians.

Because the sequencing depth of each sample are not significantly various, I applied the rarefaction as normalization.

```{r}
pseq_rar <- rarefy_even_depth(pseq)
metadata <- microbiome::meta(pseq_rar)
alpha_div <- estimate_richness(pseq_rar, measures = c("Observed", "Shannon")) %>% 
  rownames_to_column(var = "ID")
df_alpha <- merge(metadata, alpha_div, by = "ID")
```

Observed species w.r.t conditions, accounting for effect of technicians

```{r}
model_obs <- lmer(Observed ~ HOOD_BENCH + (1 | person), data = df_alpha)
anova(model_obs) %>% print()
```

Shannon index w.r.t conditions, accounting for effect of technicians

```{r}
model_shannon <- lmer(Shannon ~ HOOD_BENCH + (1 | person), data = df_alpha)
anova(model_shannon) %>% print()
```

Visualization

```{r}
plt1 <- AlphaPlot_Violin_LMM(pseq_rar, main_factor = "HOOD_BENCH", batch_factor = "person", metric = "obsered")
plt2 <- AlphaPlot_Violin_LMM(pseq_rar, main_factor = "HOOD_BENCH", batch_factor = "person", metric = "shannon")
plt1 + plt2 + plot_layout(guides = "collect")
```

## Beta Diversity

We investigate the beta diversity of samples w.r.t conditions (HOOD vs. BENCH) accounting for technicians.

### Analysis with permutation approach

We test with different transformation and different distance metric.

#### Transformation: CLR, Euclidean Space

```{r}
pseq_clr <- pseq %>% microbiome::transform(transform = "clr")
dist_matrix <- phyloseq::distance(pseq_clr, method = "euclidean")
perm <- how(blocks = metadata$person, nperm = 99999)
adonis_res <- adonis2(dist_matrix ~ HOOD_BENCH, 
                      data = metadata, 
                      #permutations = 9999
                      permutations = perm
                      )

print(adonis_res)
```

#### Transformation: compositional, bray Space

```{r}
pseq_comp <- pseq %>% microbiome::transform(transform = "compositional")
dist_matrix <- phyloseq::distance(pseq_comp, method = "bray")
perm <- how(blocks = metadata$person, nperm = 99999)
adonis_res <- adonis2(dist_matrix ~ HOOD_BENCH, 
                      data = metadata, 
                      #permutations = 9999
                      permutations = perm
                      )

print(adonis_res)
```

### Visualization

```{r}
dist_mx <- "euclidean"
otu_tab <- microbiome::abundances(pseq_clr)
# Function to get residuals from Technician effect
get_residuals <- function(taxa_vector, batch_factor) {
  # We fit: Abundance ~ Technician
  fit <- lm(taxa_vector ~ batch_factor)
  # We return the residuals
  return(residuals(fit))
}

otu_residuals <- apply(otu_tab, 1, function(x) get_residuals(x, metadata$person))
otu_residuals <- t(otu_residuals)

ps_resid <- pseq_comp
otu_table(ps_resid) <- otu_table(otu_residuals, taxa_are_rows = TRUE)

# Before (Original CLR)
ord_before <- ordinate(pseq_comp, method = "PCoA", distance = dist_mx)
p1 <- plot_ordination(pseq_comp, ord_before, color = "HOOD_BENCH", shape = "person") +
  theme_bw() + ggtitle("Before")

# After (Residuals)
ord_after <- ordinate(ps_resid, method = "PCoA", distance = dist_mx)
p2 <- plot_ordination(ps_resid, ord_after, color = "HOOD_BENCH", shape = "person") +
  theme_bw() + ggtitle("After")

p1 + p2 + plot_layout(guides = "collect")
```

**Remarks**: With compositional transformation and bray distance, the NCT samples are significantly different between HOOD vs. BENCH when accounting for technicians.

# DAA
